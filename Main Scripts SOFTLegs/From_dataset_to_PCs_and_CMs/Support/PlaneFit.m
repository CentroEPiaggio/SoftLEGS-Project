function [fitresult, gof, type] = PlaneFit(X, Y, Z, n_PC, signal,flag_display_figures,Q_or_TH,STR_INIT)
%PlaneFit(X,Y,Z)
%  Create a fit.
%
%  Data for 'untitled fit 1' fit:
%      X Input : X
%      Y Input : Y
%      Z Output: Z
%  Output:
%      fitresult : a fit object representing the fit.
%      gof : structure with goodness-of fit info.
%
%  See also FIT, CFIT, SFIT.

%  Auto-generated by MATLAB on 08-Feb-2017 12:36:46

% size(X)
% size(Y)
% size(Z)

%% Fit Scattered Data with a Plane
[xData, yData, zData] = prepareSurfaceData( X, Y, Z );

% % % % % Set up fittype and options.
% % % % type='poly11';
% % % % ft = fittype( type );
% % % % opts = fitoptions( 'Method', 'LinearLeastSquares' );
% % % % opts.Robust = 'Bisquare';
% % % % 
% % % % % Fit model to data.
% % % % [fitresult11, gof11] = fit( [xData, yData], zData, ft, opts );
% % % % 
% % % % type='poly22';
% % % % ft = fittype( type );
% % % % opts = fitoptions( 'Method', 'LinearLeastSquares' );
% % % % opts.Robust = 'Bisquare';
% % % % 
% % % % % Fit model to data.
% % % % [fitresult22, gof22] = fit( [xData, yData], zData, ft, opts );
% % % % 
% % % % if gof11.rsquare>=gof22.rsquare
% % % %     fitresult=fitresult11;
% % % %     gof=gof11;
% % % % else
% % % %     fitresult=fitresult22;
% % % %     gof=gof22;
% % % % end

type='poly22';
ft = fittype( type );
opts = fitoptions( 'Method', 'LinearLeastSquares' );
opts.Robust = 'Bisquare';

% Fit model to data.
[fitresult22, gof22] = fit( [xData, yData], zData, ft, opts );

    fitresult=fitresult22;
    gof=gof22;


% Plot fit with data.
figure('Name', strcat('Planar Fitting PC: ',signal,' ',num2str(n_PC)),'visible',flag_display_figures);
h = plot( fitresult, [xData, yData], zData);
legend( h, 'Planar Fitting', 'Raw Data', 'Location', 'NorthEast' );
% Label axes
xlabel('Forward Speed')
ylabel('Step Height')
zlabel('PC Coefficient')
grid on
%title(strcat('Joint: ',signal,', PC num.:',num2str(n_PC)));
title(strcat(signal,', PC num.:',num2str(n_PC)));
set(gca,'FontSize',20)

view(135,15)
% save fitresult fitresult

if flag_display_figures
    mkdir([STR_INIT,'Figures'])
    name=strcat('Planar Fitting PC ',signal,' ',num2str(n_PC));
    savefig(gcf,[STR_INIT,'Figures/',Q_or_TH,'_',name]);
end

